# Methods idea

## Analysis method

### Procedure

1. それぞれのHRVデータの計算
    1. 心電図測定 (2017-07-oo ~ 2024-oo-oo by prof.): done
    2. 心電図の前処理 (ノイズ除去，15分間のデータをできるだけ使うようにする，Rピークの検出 with MATLAB): done
    3. 検出したRピークからR-R intervalを計算 (with MATLAB): done
    4. HRVの計算 (with MATLAB): done
2. 気象要因データの取得と前処理
    1. 気象要因データを日本の気象庁のデータベースからCSV形式でダウンロード，[ここ](https://www.data.jma.go.jp/gmd/risk/obsdl/)
    2. それぞれの要因について標準化 (mean=0, sigma=1) 回帰分析の時比較をできるように (with R) (yはそのまま)
3. HRVデータと気象要因データの期間の調整
    1. HRVデータを気象要因データに合わせる形で結合．HRVデータに合わせると日付が崩れちゃって周期の推定が難しくなるかも? -> HRVの欠測値は予測する形で補完．~~天気データはローカルトレンドモデルで補完? 線形補完とかでもあんまり変わらないならそれでもいいかな~~ 異なる年の同じ日付の平均値を代入値として使う．
    ~~Or, 気象要因データをHRVデータに合わせる形で結合，欠損値の扱いがないから楽．~~
4. 回帰モデルの作成と推論
    1. 説明変数と目的変数に分ける．説明変数は気象要因，目的変数は各HRVパラメータ．
    2. stanコードをキック
5. 結果の確認とモデル評価
    1. トレースプロットの確認，収束してる?
    2. Rhatも一応確認，Rhat <= 1.1
    3. サンプリングされたparameterのヒストグラムで分布の確認
    4. モデルの情報，計算した評価指標を残しておく (どんなモデルを使って，評価指標の大小を比較できるように)
6. 予測結果の評価
    1. 残差の分布
    2. RMSEの計算
    3. 残差の自己相関
7. 回帰係数の結果評価
    1. ヒストグラムで分布を確認
    2. それぞれの回帰係数の期待値(EAP)を計算する
    3. 絶対値の大きい方から50%を残す

1st option: 一番シンプルなモデル (計算時間を抑えるため)を使って予測 (1階差分 or 2階差分)，偏回帰係数の上位50%の説明変数を残す，その説明変数を使って変数減少法に従いながらRMSE (or WAIC)を基準にして特に影響が大きい説明変数を探す．(一番いい組み合わせを見つけて採用された説明変数が影響あるんでしょ的な)

2nd option: ~~複数のモデルを使っていいモデルを探す，つまりyによってモデルを変える．正直HRVのデータに欠測値があってそれを飛ばしてるから365日の季節項とか1週間の季節項を入れにくいから，季節項があるモデルを使うなら，何らかの方法でHRVのデータを補完する方がいいかな．うーん，1stの方がいいと思う．MCMCの計算時間で比較するのに時間かかるし．~~

3rd option: 1st optionの特徴量選択をした次のステップとして，残った半分の気象要因のラグ変数を特徴量に加えて偏回帰係数の推定をする．x日前の気象にも影響されてるっていう議論が展開できる．
ただこれをするにはHRVが測定されていない日の補完，気象要因の欠損値の補完をしてちゃんと毎日のデータがあるようにしないと正しくx日前って言えなくなっちゃう．欠測値の補完はどうしよう．同じモデルで補完する? 特徴量選択部分で補完部分の予測もする? -> 欠測値があっても状態の遷移は推定される (状態は以前の状態から推測される)から，欠測値がある部分は条件分岐で欠測値の予測だけ行うようにした．
天気データの補完はどうしよう，HRVは推定と補完を特徴量選択の部分でするとして．-> 異なる年の同じ日付の平均値
と思ったけど，二つのステップをふむかそれとも一気にラグ変数まで含めて推定するかどうしようかな．うーん，一気にやった方がいいかな．データも半分こしなくて済むだろうし．データ二度漬け問題 -> 変数減少法みたいなもんだから大丈夫でしょう．

3rd + alhpa: 1stステップで変数選択，2ndステップでラグ変数を入れるんだけど．1stステップで残った6個の中でとりあえず大小がこんなっていう結果を出す．そして，ある報告では近くに台風がくると頭が痛くなるという人がいて，その日の天気だけじゃなくて前の日の天気にも影響されるのではないか．-> そもそもx日前の天気が影響するってどういうこと? ゆっくり影響を与えてるってこと? ラグ変数使ってる先行研究は目的変数が罹患者数つまり病院にかかった人の数だからx日前の気象要因を説明変数に加えるのはよくわかる(その日の天候が影響してすぐに病気になるとは考えられないし，悪化してから数日して病院に行くこともよく考えられるから)けど，その日の心拍変動はその日の天候によって影響されそうじゃん．1日前の天気が今の心拍変動に影響を与えるって考えると，うーん．影響はあっても小さそう．人間の体はちょうど今の環境に適応するように働くはずだから．って考えるとラグ変数は考慮しなくてもいいかな．ラグ変数はfuture workの中に含めればいいと思う．つまりこのoptionは使わない方針で．

4th option: 1stと3rdを合わせた感じ．まずラグ変数を含めたモデルをスパースモデルで変数選択する．回帰係数EAPの絶対値上位50%を残して，そこから変数減少法で最良な組み合わせを見つけてそれを最終的なモデルとする．もしくは上位50%を残した時点でもう終了でも良い．-> ちょっと試したけど，係数がほとんど0に近いし時間もかかるからどうしようかな．

---
1st optionを使っていこうと思う．3rd option以降の案はラグ変数を使ってる，これはfuture workとして残しておく(ラグの影響があっても小さいと思うし)．2nd optionはありだけど，組み合わせが無限すぎるし，多分不可能(妥当なモデルを作成するための知識と能力がない)から1st optionがメインになると思う．
- とりあえず1st optionを進める．つまり，偏回帰係数の絶対値が大きい上位50%の説明変数を残す: done
- その残った説明変数で変数増減法 (stepwise)に従いながら評価基準の一番いい変数の組み合わせを見つける．例えば6個に減らしたあと，他の6個のうち1つを追加して情報量基準をみていいか悪いかを判断する．__ここで，評価基準を決めなきゃいけない__
- MCMC，SSM，WAICも? 勉強しなきゃいけない
---

### Regression models

- Space state model with MCMC
    - 柔軟な表現力
    - ベイズで何が嬉しいのか:
        - パラメータを確率変数として考え，分布を推測するからパラメータの解釈がしやすい，伝統的な統計学ではパラメータは一点の定数と考えるから解釈が難しい．"パラメータがこの範囲にあるのはこの確率"と言える．
        - 不確実さを表現できる，つまり信用区間で"データが得られた時のパラメータの確率の幅"を表現できるから，このくらいの幅で変化するんだなって定量的に示せる．不確実性は事後分布として示されるから，EAP推定値とかだけでなく，変動幅も評価できる．
        - 一貫した流れで分析ができる，つまり，推論の流れがデータによって変わらないから信頼できる結果が得られやすい．
        - ~~ASA声明~~
    - 欠損値をそのまま扱えて，欠損値を補完してくれる

- ~~ベイズ構造時系列モデル~~
    - ~~状態空間モデルのうちの一つ．spike-and-slab priorを使った変数選択ができる(?)．~~
    - ~~説明しやすい(?)．~~
    - ~~天気を介入だとすれば似たような研究もありそう．~~
- ~~ベイジアン変化点検出モデル~~
    - ~~心拍変動の変化点以前になにか特徴的な気象の変動があったと~~

- ~~ARモデル系のパラメータをベイズ推定~~
    - ~~AR系は外生変数を含まないから今回には合わない~~

- ~~ARIMAX, SARIMAX, RegARIMA系 + ベイズ推定~~
    - わからん
    - ~~モデルの解釈が難しい．例えばARの部分はわかりやすい(ラグいくつまでの値が影響しているとか)けど，残差を取るところが難しいかな(?)~~

- ~~自己回帰分布ラグモデル(?)~~

__どうして状態空間モデルを使うのか__
- ARモデル系は定常過程に変換しなきゃいけないから，そのあとの解釈が容易でない．状態空間モデルはそのままデータを使えるから解釈がしやすい．
- 欠損値があっても推論ができるから，欠損値に左右されずに影響の分析ができる．
- 状態空間モデルは"状態"と"観測値"を分けてモデル化するから，人間の身体のように，目で見えない健康状態とそこから測定する心電図っていう関係が当てはめられる．
- 基本構造時系列モデルのように，時系列のデータを様々な要因に分けて推定できるので，ある周期での自然な変動と気候の影響による変動を分けて推測できる．

__ベイズ統計を使うと何が嬉しいの?__
- ベイズ統計はベイズの定理に基づく方法である．
- モデルのパラメータが確率分布で表現できるから，影響するパラメータの値の範囲が見えて解釈しやすい．説明可能性を大きく持ったまま分析ができる．
- ~~因果推論の枠組みにも対応できるから，爆弾低気圧っていう介入の影響とかを分析できそう．~~
- ~~事前に持っている情報を事前分布の形で反映でき，より考えられる結果を得られる?~~
- 結果として出力されるものは，パラメータに関する直接の確率だから，伝統的な頻度主義統計学の仮説検定のp値のような解釈の難しい値を使わなくて済む．つまり，結果の理解が伝統的な統計学より容易になる．

### Feature engineering

- 標準化 -> MCMCサンプリングの時間短縮，収束に役立つ．あとは正規化よりも理解しやすい? mu = 0, sigma = 1
- Max
- Min
- Ave
- 前日との差 (前日に限らず)
- Max - Min
- ラグを取る
- 同じような変動をするやつでも使ってみる?
    - 範囲が違うからいいかな，
- __最大とかの時分はその時間の生体情報の計測が存在しないことがほとんどだから使わなくていいかな__
- ~~季節変動のためのダミー変数を入れる代わりに，説明変数の季節変動を抑える．例えば移動平均を引くとか．~~

### Tips

- モデル選択は何を基準に進めるの? WAICとかいろいろあるよね -> WAICを基準にモデル選択する or RMSE or Bayes factor

- モデルが確定したあとに，モデルの妥当性を確認するために生データと予測の残差をとってホワイトノイズに近づいているか確認する．

- 変数減少法とか
    - 1ステップ目に回帰係数の絶対値の大きさ下位50%を削るのも減少法に沿ってやってるようなもんかな

- ~~多重共線性~~: むり

- CVの切り方，最後の数ヶ月を検証用データとして切っておくとか，Hold-out, ~~Leave-one-out for time series~~

- どうモデルを理解すればいいの?係数の比較によってかな ([偏回帰係数](https://avilen.co.jp/personal/knowledge-article/multiple-regression-analysis/))
    - 説明変数が1シグマ変化した時のyの変化的な

- ベイズ統計で分析する時に報告すべき情報たち [Bayesian analysis guildelines](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8526359/)
    - 事前分布は何を設定したの? -> ラプラス分布(二重指数分布, mu=0, sigma=..."
    - 信用区間は何を設定したの? -> 95% (他の論文もそんな感じ)
    - 感度分析 (?)
    - MCMCの収束はどう判断したの?
    - どんなモデルを使ったの?
    - どうやってモデル選択したの? -> 正則化モデルで変数選択(半分くらいに減らす?)してからRMSEを評価基準に変数減少法でモデル選択．変数選択をすることによって変数の数が減るからモデルが重要だと考える変数だけ残って，解釈性が高くなる．つまり理解しやすい結果が得られる．
    - Bayesian analysis guildelinesに沿って結果を報告する．

- 相関がある変数に対して多変量正規分布を用いるといいらしい [ref.](https://knknkn.hatenablog.com/entry/2019/06/21/101142)

- ~~spike-and-slab priorを使うとか，二重指数分布(ラプラス分布)を使うとかすると，正則化として働く~~
    - ~~変数パラメータの事前分布としてラプラス分布，spike-and-slab，horseshoeとか色々あるからそれらが変数選択の役としていいかも~~
    -> Laplace distribution (mu = 0, tau for scale parameter is estimated)

- WAICの計算方法

### Visualization

- 似た天気の日は似たHRVの値になるのかクラスタリングしてみたり．

- いつもよりHRVの値が違う日に注目して，その日の24時間分の天気を見てなんか特徴的な天気がないか見てみる．

- インパルス応答とか見てみたり．

## HRV parameters

Time domain
- Heart rate (beats/min)
- SDNN, RMSSD (msec)
- pnn50 (%)
- TINN (msec) (?)

Frequency domain
- VLF, LF, HF ($msec^2$)
- LF/HF (%)


~~_non-linear_ domain (option  time/frequency domain params are not related)~~
- ~~_CD_ (-)~~
- ~~_ApEn_ (-)~~
- ~~_SD1, SD2_ (msec)~~
- ~~_SD1/SD2_ (%)~~

[HRV parameters calculation](https://github.com/MarcusVollmer/HRV)

相関があるやつはどっちか消してもいいかな
-> 相関のヒートマップから判断してもいいかな，自律神経系の指標となりうるものを優先して残しながら選択していけばいいと思う
-> ~~SD1はRMSSD，SD2はLF，SD1/SD2はLF/HFと相関があるからいらない？？？~~ オプションとして残しておくけど，使わない可能性大

## Meteorological factors

気象要因の平均，最小，最大は相関が高いだろうから，まずは平均を使ってみて，次に平均ではなく最小を使ってみて，次に最大を使ってみて，それらをモデル選択の要領で比較して最もいいものを採用するとか．もしくは，それらが終わった後に違うやつを加えてみて(例えば平均が一番いいってわかったら，説明変数に最大を加えて情報量が変わるかどうかとか)良くなるかをみてみるとか．

あと，それぞれの気象要因の組み合わせもあるだろうから色々試してみるしかない．

### Features (daily)

- 湿度系
    - ~~日平均蒸気圧 (hPa)~~ 相対湿度と気温から導出できるやつだから
    - 日平均相対湿度 (%)
    - 日最小相対湿度 (%)
    - ~~日最小値の発生時刻 (option)~~

- 気圧系
    - ~~日平均現地気圧 (hPa)~~ 現地気圧は標高によって左右されてしまう．一方海面気圧は現地気圧が補正されて海面0mの気圧に換算している．研究結果を一般化しようとする時，どの場所でも同じ条件になる海面気圧の方が良いと思うから海面気圧のみ採用する，かな．
    - 日平均海面気圧 (hPa)
    - 日最低海面気圧 (hPa)
    - ~~日最低海面気圧発生時刻 (option)~~

- 雨系
    - 日合計降水量 (mm)
    - 日最大1時間降水量 (mm)
    - ~~日最大1時間降水の発生時刻 (option)~~

- 日光系
    - 日合計日照時間 (hour)

- 気温系
    - 日平均気温 (℃)
    - 日最高気温 (℃)
    - ~~日最高気温発生時刻 (option)~~
    - 日最低気温 (℃)
    - ~~日最低気温発生時刻 (option)~~

- 風系
    - 日平均風速 (m/s)
    - 日最大風速 (m/s)
    - ~~日最大風速発生時刻 (option)~~
    - ~~日最大風速風向 (東西南北)~~
    - ~~日瞬間最大風速 (m/s)~~
    - ~~日瞬間最大風速発生時刻 (option)~~
    - ~~日瞬間最大風速風向 (東西南北)~~
    - ~~日最多風向 (東西南北)~~

- 雪系
    - ~~最深積雪 (cm)~~ これもいらないかな，降雪量合計だけで1日の天気はわかるし，残った雪に積もった雪の深さは関係なさそう．気温と降雪量でわかりそう．
    - ~~最深積雪時分~~
    - 降雪量合計 (cm)
---

Possible
- _Lunar cycle_
- _Weathr front_
- _Thunder_
- _Fog_
- _真夏日，猛暑日，ゲリラ豪雨，台風，爆弾低気圧(要定義確認)，熱帯夜みたいな気象イベント_
- _連続した雨とか曇りの日_
- _平均だけとかじゃなくて，ある特定の時間のデータを使う_
- _四季_
- _曜日_

## Figure
- 使った特徴量を気象要因とHRVでそれぞれ表をつくる
